<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymRank - Competitive Lifting Platform</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèãÔ∏è</text></svg>">
  <link href="./src/output.css" rel="stylesheet">
</head>
<body class="bg-background text-foreground min-h-screen transition-colors">
  <style>
    :root {
      /* Light theme colors */
      --background: #ffffff;
      --foreground: #0f172a;
      --card: #ffffff;
      --card-foreground: #0f172a;
      --border: #e2e8f0;
      --input: #ffffff;
      --primary: #8b5cf6;
      --primary-foreground: #ffffff;
      --muted: #f1f5f9;
      --muted-foreground: #64748b;
      --destructive: #ef4444;
      --accent: #f1f5f9;
      --ring: #8b5cf6;
    }

    [data-theme="dark"] {
      /* Dark theme colors */
      --background: #0f172a;
      --foreground: #f8fafc;
      --card: #1e293b;
      --card-foreground: #f8fafc;
      --border: #334155;
      --input: #1e293b;
      --primary: #8b5cf6;
      --primary-foreground: #ffffff;
      --muted: #334155;
      --muted-foreground: #94a3b8;
      --destructive: #ef4444;
      --accent: #334155;
      --ring: #8b5cf6;
    }

    .bg-background { background-color: var(--background); }
    .text-foreground { color: var(--foreground); }
    .bg-card { background-color: var(--card); }
    .text-card-foreground { color: var(--card-foreground); }
    .border-border { border-color: var(--border); }
    .bg-input { background-color: var(--input); }
    .bg-primary { background-color: var(--primary); }
    .text-primary { color: var(--primary); }
    .text-primary-foreground { color: var(--primary-foreground); }
    .bg-muted { background-color: var(--muted); }
    .text-muted-foreground { color: var(--muted-foreground); }
    .text-destructive { color: var(--destructive); }
    .bg-destructive { background-color: var(--destructive); }
    .hover\\:bg-muted:hover { background-color: var(--muted); }
    .hover\\:bg-accent:hover { background-color: var(--accent); }
    .hover\\:bg-primary\\/90:hover { background-color: color-mix(in srgb, var(--primary) 90%, transparent); }
    .hover\\:bg-destructive:hover { background-color: var(--destructive); }
    .hover\\:text-white:hover { color: #ffffff; }
    .focus\\:border-ring:focus { border-color: var(--ring); }
    .focus\\:ring-2:focus { box-shadow: 0 0 0 2px var(--ring); }
    
    /* Smooth transitions for theme switching */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
  </style>
  <!-- Navigation Header -->
  <nav class="bg-card border-b border-border sticky top-0 z-50 transition-colors">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <h1 class="text-2xl font-bold">üèãÔ∏è GymRank</h1>
        </div>
        <div class="flex items-center space-x-1">
          <button onclick="showSection('home')" id="nav-home" class="nav-btn px-4 py-2 rounded-md font-medium transition-colors hover:bg-muted">
            Home
          </button>
          <button onclick="showSection('videos')" id="nav-videos" class="nav-btn px-4 py-2 rounded-md font-medium transition-colors hover:bg-muted">
            Videos
          </button>
          <button onclick="showSection('leaderboard')" id="nav-leaderboard" class="nav-btn px-4 py-2 rounded-md font-medium transition-colors hover:bg-muted">
            Leaderboard
          </button>
          <button onclick="showSection('teams')" id="nav-teams" class="nav-btn px-4 py-2 rounded-md font-medium transition-colors hover:bg-muted">
            Teams
          </button>
          <div id="user-info" class="hidden ml-4 px-3 py-1 bg-muted text-sm font-medium flex items-center space-x-2 cursor-pointer hover:bg-accent transition-colors rounded" onclick="showSection('profile')">
            <div id="logged-in-user" class="flex items-center space-x-2"></div>
          </div>
          <button id="logout-btn" onclick="logout()" class="hidden ml-2 px-3 py-1 text-destructive hover:bg-destructive hover:text-white transition-colors text-sm font-medium">
            Logout
          </button>
          <button id="theme-toggle" onclick="toggleTheme()" class="mr-2 p-2 rounded-md hover:bg-muted transition-colors" title="Toggle dark mode">
            <span id="theme-icon">üåô</span>
          </button>
          <div id="auth-buttons" class="flex items-center space-x-2">
            <a href="login.html" class="px-4 py-2 text-foreground hover:bg-muted transition-colors font-medium">
              Login
            </a>
            <a href="register.html" class="px-4 py-2 bg-primary text-primary-foreground hover:bg-primary/90 transition-colors font-medium">
              Register
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <!-- Home Section -->
    <div id="home-section" class="section">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">Welcome to GymRank</h2>
        <p class="text-muted-foreground">Competitive lifting platform inspired by Bakugan rankings</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-card border border-border rounded-lg p-6 transition-colors">
          <h3 class="font-semibold text-lg mb-2">Total Lifters</h3>
          <p class="text-3xl font-bold text-primary" id="total-users">-</p>
        </div>
        <div class="bg-card border border-border rounded-lg p-6 transition-colors">
          <h3 class="font-semibold text-lg mb-2">Total PRs</h3>
          <p class="text-3xl font-bold text-primary" id="total-prs">-</p>
        </div>
        <div class="bg-card border border-border rounded-lg p-6 transition-colors">
          <h3 class="font-semibold text-lg mb-2">Top DOTS</h3>
          <p class="text-3xl font-bold text-primary" id="top-elo">-</p>
        </div>
      </div>

      <!-- PR Submission Section (Only for logged-in users) -->
      <div id="pr-section" class="bg-card border border-border rounded-lg p-6 hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-semibold mb-2">ü•á Prove Your Strength</h2>
          <p class="text-muted-foreground">Submit your personal best and rise through the leaderboard!</p>
        </div>
        
        <form id="combined-pr-form" class="space-y-4" enctype="multipart/form-data">
          <div>
            <label class="block text-sm font-medium mb-2">Lift Type</label>
            <select id="lift-type" class="w-full px-3 py-2 border-2 border-border bg-input focus:outline-none focus:border-ring">
              <option value="bench">Bench Press</option>
              <option value="deadlift">Deadlift</option>
              <option value="squat">Squat</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Weight (kg)</label>
            <input type="number" id="weight" class="w-full px-3 py-2 border-2 border-border bg-input focus:outline-none focus:border-ring" placeholder="Enter weight in kg" step="0.5" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Instagram Video Link (Required)</label>
            <input type="url" id="instagram-url" class="w-full px-3 py-2 border-2 border-border bg-input focus:outline-none focus:border-ring" placeholder="https://www.instagram.com/reel/..." required>
            <p class="text-sm text-muted-foreground mt-1">Required: Instagram reel or video link ‚Ä¢ Must be a valid Instagram URL</p>
          </div>
          <button type="submit" class="w-full bg-primary text-primary-foreground py-3 px-4 hover:bg-primary/90 transition-colors font-medium">
            Submit PR
          </button>
        </form>
      </div>

      <!-- Welcome Message for Non-logged-in Users -->
      <div id="welcome-section" class="bg-card border border-border rounded-lg p-8 text-center transition-colors">
        <h2 class="text-2xl font-semibold mb-4">Welcome to GymRank!</h2>
        <p class="text-muted-foreground mb-6">Join the competitive lifting platform inspired by Bakugan rankings</p>
        <div class="flex justify-center space-x-4">
          <a href="register.html" class="px-6 py-3 bg-primary text-primary-foreground hover:bg-primary/90 transition-colors font-medium">
            Get Started
          </a>
          <a href="login.html" class="px-6 py-3 border border-border hover:bg-muted transition-colors font-medium">
            Sign In
          </a>
        </div>
      </div>
    </div>

    <!-- Videos Section -->
    <div id="videos-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üìπ PR Videos</h2>
        <p class="text-muted-foreground">Watch incredible lifts from our community</p>
      </div>
      
      <div class="bg-card border border-border rounded-lg p-6 transition-colors">
        <div id="videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <div class="flex justify-center items-center py-8 col-span-full">
            <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaderboard Section -->
    <div id="leaderboard-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üèÜ Leaderboard</h2>
        <p class="text-muted-foreground">Top lifters ranked by DOTS score (Bodyweight adjusted)</p>
      </div>
      
      <!-- Filter Controls -->
      <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
        <!-- Gender Filter Buttons -->
        <div class="bg-muted border border-border rounded-lg p-1 flex space-x-1">
          <button onclick="setActiveFilter('all'); loadLeaderboard('', currentCountryFilter);" id="filter-all" class="filter-btn px-4 py-2 rounded font-medium transition-colors bg-primary text-primary-foreground">
            All
          </button>
          <button onclick="setActiveFilter('male'); loadLeaderboard('male', currentCountryFilter);" id="filter-male" class="filter-btn px-4 py-2 rounded font-medium transition-colors hover:bg-accent">
            ‚ôÇÔ∏è Men
          </button>
          <button onclick="setActiveFilter('female'); loadLeaderboard('female', currentCountryFilter);" id="filter-female" class="filter-btn px-4 py-2 rounded font-medium transition-colors hover:bg-accent">
            ‚ôÄÔ∏è Women
          </button>
        </div>
        
        <!-- Country Filter Dropdown -->
        <div class="flex items-center space-x-2">
          <label for="country-filter" class="text-sm font-medium text-muted-foreground">Country:</label>
          <select id="country-filter" onchange="filterByCountry(this.value)" class="bg-card border border-border rounded px-3 py-2 text-sm min-w-[150px] focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">All Countries</option>
            <option value="üá∫üá∏">üá∫üá∏ United States</option>
            <option value="üá¨üáß">üá¨üáß United Kingdom</option>
            <option value="üá®üá¶">üá®üá¶ Canada</option>
            <option value="üá¶üá∫">üá¶üá∫ Australia</option>
            <option value="üá©üá™">üá©üá™ Germany</option>
            <option value="üá´üá∑">üá´üá∑ France</option>
            <option value="üáØüáµ">üáØüáµ Japan</option>
            <option value="üá∞üá∑">üá∞üá∑ South Korea</option>
            <option value="üá®üá≥">üá®üá≥ China</option>
            <option value="üáÆüá≥">üáÆüá≥ India</option>
            <option value="üáßüá∑">üáßüá∑ Brazil</option>
            <option value="üá≤üáΩ">üá≤üáΩ Mexico</option>
            <option value="üá∑üá∫">üá∑üá∫ Russia</option>
            <option value="üáÆüáπ">üáÆüáπ Italy</option>
            <option value="üá™üá∏">üá™üá∏ Spain</option>
            <option value="üá≥üá±">üá≥üá± Netherlands</option>
            <option value="üá∏üá™">üá∏üá™ Sweden</option>
            <option value="üá≥üá¥">üá≥üá¥ Norway</option>
            <option value="üá©üá∞">üá©üá∞ Denmark</option>
            <option value="üá´üáÆ">üá´üáÆ Finland</option>
            <option value="üá∏üá¨">üá∏üá¨ Singapore</option>
            <option value="üá≠üá∞">üá≠üá∞ Hong Kong</option>
            <option value="üáπüáº">üáπüáº Taiwan</option>
            <option value="üáπüá≠">üáπüá≠ Thailand</option>
            <option value="üá≤üáæ">üá≤üáæ Malaysia</option>
            <option value="üáÆüá©">üáÆüá© Indonesia</option>
            <option value="üáµüá≠">üáµüá≠ Philippines</option>
            <option value="üáªüá≥">üáªüá≥ Vietnam</option>
            <option value="üáøüá¶">üáøüá¶ South Africa</option>
            <option value="üá≥üá¨">üá≥üá¨ Nigeria</option>
            <option value="üá™üá¨">üá™üá¨ Egypt</option>
          </select>
        </div>
      </div>
      
      <div class="bg-card border border-border rounded-lg p-6 transition-colors">
        <div id="leaderboard" class="space-y-3">
          <div class="flex justify-center items-center py-8">
            <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Teams Section -->
    <div id="teams-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üèüÔ∏è Team Competition</h2>
        <p class="text-muted-foreground">Team rankings and competitions</p>
      </div>
      
      <div class="bg-card border border-border rounded-lg p-6 transition-colors">
        <div id="team-leaderboard" class="space-y-3">
          <div class="flex justify-center items-center py-8">
            <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üë§ My Profile</h2>
        <p class="text-muted-foreground">Manage your posts and profile settings</p>
      </div>
      
      <!-- Progress Charts -->
      <div class="mb-8">
        <div class="bg-card border border-border rounded-lg p-6 transition-colors">
          <h3 class="text-xl font-bold mb-6">üìà Progress Charts</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Bench Press Chart -->
            <div class="bg-muted rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                  <span class="text-2xl">üèãÔ∏è</span>
                  <div>
                    <h4 class="font-semibold">Bench Press</h4>
                    <p class="text-sm text-muted-foreground" id="bench-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-muted-foreground">Trend</div>
                  <div id="bench-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="h-32 relative">
                <canvas id="bench-chart" class="w-full h-full"></canvas>
              </div>
            </div>
            
            <!-- Squat Chart -->
            <div class="bg-muted rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                  <span class="text-2xl">ü¶µ</span>
                  <div>
                    <h4 class="font-semibold">Squat</h4>
                    <p class="text-sm text-muted-foreground" id="squat-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-muted-foreground">Trend</div>
                  <div id="squat-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="h-32 relative">
                <canvas id="squat-chart" class="w-full h-full"></canvas>
              </div>
            </div>
            
            <!-- Deadlift Chart -->
            <div class="bg-muted rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                  <span class="text-2xl">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                  <div>
                    <h4 class="font-semibold">Deadlift</h4>
                    <p class="text-sm text-muted-foreground" id="deadlift-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-muted-foreground">Trend</div>
                  <div id="deadlift-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="h-32 relative">
                <canvas id="deadlift-chart" class="w-full h-full"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Profile Settings -->
        <div class="lg:col-span-1">
          <div class="bg-card border border-border rounded-lg p-6 transition-colors">
            <h3 class="text-xl font-bold mb-4">Profile Settings</h3>
            
            <form id="profile-settings-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Username</label>
                <input 
                  type="text" 
                  id="profile-username" 
                  class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring" 
                  placeholder="Username"
                >
                <p class="text-xs text-muted-foreground mt-1">Your display name</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2">Team/Gym</label>
                <input 
                  type="text" 
                  id="profile-team" 
                  class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring"
                  placeholder="Enter your team/gym name"
                >
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2">Weight (kg)</label>
                <input 
                  type="number" 
                  id="profile-weight" 
                  class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring"
                  placeholder="Enter your weight in kg"
                  step="0.1"
                  min="0"
                >
                <p class="text-xs text-muted-foreground mt-1">Your current body weight</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2">Gender</label>
                <select 
                  id="profile-gender" 
                  class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring"
                  required
                >
                  <option value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <p class="text-xs text-muted-foreground mt-1">Required for DOTS score calculation</p>
              </div>
              
              <button 
                type="submit" 
                class="w-full bg-primary text-primary-foreground py-2 px-4 hover:bg-primary/90 transition-colors font-medium"
              >
                Update Profile
              </button>
            </form>
          </div>
        </div>
        
        <!-- My Posts -->
        <div class="lg:col-span-2">
          <div class="bg-card border border-border rounded-lg p-6 transition-colors">
            <h3 class="text-xl font-bold mb-4">My Posts</h3>
            <div id="user-posts" class="space-y-4">
              <div class="flex justify-center items-center py-8">
                <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="user-profile-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-card border border-border rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold" id="modal-user-title">User Profile</h2>
        <button onclick="closeUserProfileModal()" class="text-muted-foreground hover:text-foreground transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- User Info Header -->
      <div class="bg-muted rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-4">
          <span id="modal-user-flag" class="text-4xl"></span>
          <div class="flex-1">
            <div class="flex items-center space-x-2">
              <h3 id="modal-user-username" class="text-xl font-bold"></h3>
              <span id="modal-user-gender" class="text-lg"></span>
            </div>
            <p id="modal-user-team" class="text-muted-foreground"></p>
            <div class="flex items-center space-x-4 mt-2">
              <span id="modal-user-dots" class="bg-orange-500 text-white px-3 py-1 rounded font-semibold"></span>
              <span id="modal-user-total" class="text-sm text-muted-foreground"></span>
              <span id="modal-user-bodyweight" class="text-sm text-muted-foreground"></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- PR Records -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-card border border-border rounded-lg p-4 text-center">
          <div class="text-2xl mb-2">üèãÔ∏è</div>
          <div class="text-sm text-muted-foreground">Bench Press</div>
          <div id="modal-user-bench" class="text-2xl font-bold text-primary"></div>
        </div>
        <div class="bg-card border border-border rounded-lg p-4 text-center">
          <div class="text-2xl mb-2">ü¶µ</div>
          <div class="text-sm text-muted-foreground">Squat</div>
          <div id="modal-user-squat" class="text-2xl font-bold text-primary"></div>
        </div>
        <div class="bg-card border border-border rounded-lg p-4 text-center">
          <div class="text-2xl mb-2">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
          <div class="text-sm text-muted-foreground">Deadlift</div>
          <div id="modal-user-deadlift" class="text-2xl font-bold text-primary"></div>
        </div>
      </div>
      
      <!-- Videos Section -->
      <div class="mb-6">
        <h4 class="text-lg font-semibold mb-4">üìπ PR Videos</h4>
        <div id="modal-user-videos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Videos will be loaded here -->
        </div>
      </div>
      
      <!-- PR History -->
      <div>
        <h4 class="text-lg font-semibold mb-4">üìà PR History</h4>
        <div id="modal-user-history" class="space-y-3">
          <!-- PR history will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';

    // Navigation functionality
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Remove active state from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-primary-foreground');
        btn.classList.add('text-foreground');
      });
      
      // Show selected section
      document.getElementById(`${sectionName}-section`).classList.remove('hidden');
      
      // Add active state to clicked nav button (if it exists)
      const activeBtn = document.getElementById(`nav-${sectionName}`);
      if (activeBtn) {
        activeBtn.classList.add('bg-primary', 'text-primary-foreground');
        activeBtn.classList.remove('text-foreground');
      }
      
      // Load data for specific sections
      if (sectionName === 'videos') {
        loadVideos();
      } else if (sectionName === 'leaderboard') {
        loadLeaderboard();
      } else if (sectionName === 'teams') {
        loadTeams();
      } else if (sectionName === 'profile') {
        loadUserProfile();
      } else if (sectionName === 'home') {
        loadLeaderboard(); // For stats
      }
    }


    // Theme management
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('gymrank-theme', newTheme);
      
      // Update theme icon
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('gymrank-theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      // Update theme icon
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // Load initial data and check session on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeTheme();
      initializeEventListeners();
      checkUserSession();
      showSection('home');
      loadLeaderboard();
    });

    // Initialize all event listeners
    function initializeEventListeners() {
      const combinedPrForm = document.getElementById('combined-pr-form');
      if (combinedPrForm) {
        combinedPrForm.addEventListener('submit', handleCombinedPR);
      }
    }

    // Check for saved user session on page load
    function checkUserSession() {
      const savedUser = localStorage.getItem('gymrank_user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          updateUIForLoggedInUser();
        } catch (e) {
          localStorage.removeItem('gymrank_user');
        }
      }
    }

    // Load leaderboard
    function loadLeaderboard(gender = '', country = '') {
      const params = new URLSearchParams();
      if (gender) params.append('gender', gender);
      if (country) params.append('country', country);
      const url = `${API_BASE}/api/leaderboard${params.toString() ? '?' + params.toString() : ''}`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('leaderboard');
          if (data.length === 0) {
            list.innerHTML = '<p class="text-muted-foreground text-center py-8">No qualified lifters yet. Complete all three lifts (bench, squat, deadlift) with bodyweight recorded!</p>';
            return;
          }
          
          list.innerHTML = data.map((user, index) => {
            const rankColors = ['text-yellow-500', 'text-gray-400', 'text-orange-500'];
            const rankColor = rankColors[index] || 'text-muted-foreground';
            const rank = index + 1;
            const genderEmoji = user.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
            
            return `
              <div onclick="openUserProfileModal('${user.username}')" class="flex items-center justify-between p-4 border border-border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl font-bold ${rankColor}">#${rank}</span>
                  <span class="text-2xl">${user.flag}</span>
                  <div class="flex flex-col">
                    <div class="flex items-center space-x-1">
                      <span class="font-semibold">${user.username}</span>
                      <span class="text-lg">${genderEmoji}</span>
                    </div>
                    <span class="text-sm text-muted-foreground">${user.team || 'Independent'}</span>
                    <span class="text-xs text-muted-foreground">
                      B: ${user.bench}kg | S: ${user.squat}kg | D: ${user.deadlift}kg | BW: ${user.weight}kg
                    </span>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold text-primary">${user.dots_score} DOTS</div>
                  <div class="text-sm font-medium">${user.total_lifted}kg Total</div>
                  <div class="text-sm text-muted-foreground">
                    ${rank === 1 ? 'Champion' : rank === 2 ? 'Elite' : rank === 3 ? 'Titan' : 'Brawler'}
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Update stats
          document.getElementById('total-users').textContent = data.length;
          document.getElementById('top-elo').textContent = data[0] ? data[0].dots_score : '0';
        })
        .catch(err => {
          document.getElementById('leaderboard').innerHTML = 
            '<div class="text-center py-8 text-destructive">Error loading leaderboard. Make sure the backend is running.</div>';
        });
    }

    // Set active filter button
    function setActiveFilter(filter) {
      // Update current gender filter
      currentGenderFilter = filter === 'all' ? '' : filter;
      
      // Remove active styles from all filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-primary-foreground');
        btn.classList.add('hover:bg-accent');
      });
      
      // Add active styles to selected button
      const activeBtn = document.getElementById(`filter-${filter}`);
      if (activeBtn) {
        activeBtn.classList.add('bg-primary', 'text-primary-foreground');
        activeBtn.classList.remove('hover:bg-accent');
      }
    }

    // Filter leaderboard by country
    function filterByCountry(country) {
      currentCountryFilter = country;
      loadLeaderboard(currentGenderFilter, currentCountryFilter);
    }

    // Open user profile modal
    function openUserProfileModal(username) {
      fetch(`${API_BASE}/api/user/${username}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert('Error loading user profile: ' + data.error);
            return;
          }
          
          // Populate modal with user data
          const user = data.user;
          const prs = data.current_prs;
          const genderEmoji = user.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
          
          document.getElementById('modal-user-title').textContent = `${user.username}'s Profile`;
          document.getElementById('modal-user-flag').textContent = user.flag;
          document.getElementById('modal-user-username').textContent = user.username;
          document.getElementById('modal-user-gender').textContent = genderEmoji;
          document.getElementById('modal-user-team').textContent = user.team || 'Independent';
          document.getElementById('modal-user-dots').textContent = data.dots_score ? `${data.dots_score} DOTS` : 'N/A';
          document.getElementById('modal-user-total').textContent = `${data.total_lifted}kg Total`;
          document.getElementById('modal-user-bodyweight').textContent = `${user.weight}kg BW`;
          
          // Populate PR records
          document.getElementById('modal-user-bench').textContent = prs.bench ? `${prs.bench}kg` : 'N/A';
          document.getElementById('modal-user-squat').textContent = prs.squat ? `${prs.squat}kg` : 'N/A';
          document.getElementById('modal-user-deadlift').textContent = prs.deadlift ? `${prs.deadlift}kg` : 'N/A';
          
          // Populate videos
          const videosContainer = document.getElementById('modal-user-videos');
          if (data.videos.length === 0) {
            videosContainer.innerHTML = '<p class="text-muted-foreground text-center py-4 col-span-full">No videos available</p>';
          } else {
            videosContainer.innerHTML = data.videos.map(video => {
              const liftEmoji = video.lift_type === 'bench' ? 'üèãÔ∏è' : video.lift_type === 'squat' ? 'ü¶µ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
              return `
                <div class="border border-border rounded-lg p-3 bg-card">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                      <span class="text-lg">${liftEmoji}</span>
                      <div>
                        <div class="font-semibold">${video.weight}kg</div>
                        <div class="text-xs text-muted-foreground capitalize">${video.lift_type}</div>
                      </div>
                    </div>
                    <a href="${video.video_url}" target="_blank" rel="noopener noreferrer" 
                       class="text-purple-600 hover:text-purple-800 font-medium underline text-xs">
                      View ‚Üí
                    </a>
                  </div>
                  <div class="text-xs text-muted-foreground">
                    ${new Date(video.created_at).toLocaleDateString()}
                  </div>
                </div>
              `;
            }).join('');
          }
          
          // Populate PR history
          const historyContainer = document.getElementById('modal-user-history');
          if (data.history.length === 0) {
            historyContainer.innerHTML = '<p class="text-muted-foreground text-center py-4">No PR history available</p>';
          } else {
            historyContainer.innerHTML = data.history.map(record => {
              const liftEmoji = record.lift_type === 'bench' ? 'üèãÔ∏è' : record.lift_type === 'squat' ? 'ü¶µ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
              return `
                <div class="flex items-center justify-between p-3 border border-border rounded-lg">
                  <div class="flex items-center space-x-3">
                    <span class="text-xl">${liftEmoji}</span>
                    <div>
                      <div class="font-semibold">${record.weight}kg ${record.lift_type}</div>
                      <div class="text-xs text-muted-foreground">${new Date(record.created_at).toLocaleDateString()}</div>
                    </div>
                  </div>
                  ${record.video_url ? `
                    <a href="${record.video_url}" target="_blank" rel="noopener noreferrer" 
                       class="text-purple-600 hover:text-purple-800 font-medium underline text-sm">
                      Video ‚Üí
                    </a>
                  ` : ''}
                </div>
              `;
            }).join('');
          }
          
          // Show modal
          document.getElementById('user-profile-modal').classList.remove('hidden');
        })
        .catch(err => {
          console.error('Error loading user profile:', err);
          alert('Failed to load user profile');
        });
    }

    // Close user profile modal
    function closeUserProfileModal() {
      document.getElementById('user-profile-modal').classList.add('hidden');
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('user-profile-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeUserProfileModal();
        }
      });
      
      // Redraw charts on window resize
      window.addEventListener('resize', function() {
        if (currentUser && document.getElementById('profile-section').classList.contains('section') && !document.getElementById('profile-section').classList.contains('hidden')) {
          setTimeout(loadProgressCharts, 100);
        }
      });
    });

    // Progress Chart Functions
    function drawProgressChart(canvasId, data, liftType) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !data || data.length === 0) return;
      
      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * 2; // For retina displays
      canvas.height = rect.height * 2;
      ctx.scale(2, 2);
      
      const width = rect.width;
      const height = rect.height;
      const padding = 20;
      const chartWidth = width - (padding * 2);
      const chartHeight = height - (padding * 2);
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      
      if (data.length === 0) {
        ctx.fillStyle = '#9CA3AF';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No data yet', width / 2, height / 2);
        return;
      }
      
      // Find min and max values
      const weights = data.map(d => d.weight);
      const minWeight = Math.min(...weights);
      const maxWeight = Math.max(...weights);
      const weightRange = maxWeight - minWeight || 1;
      
      // Draw grid lines
      ctx.strokeStyle = '#E5E7EB';
      ctx.lineWidth = 1;
      
      // Horizontal grid lines
      for (let i = 0; i <= 4; i++) {
        const y = padding + (chartHeight * i / 4);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }
      
      // Draw line chart
      if (data.length > 1) {
        ctx.strokeStyle = '#8B5CF6'; // Purple color
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        data.forEach((point, index) => {
          const x = padding + (chartWidth * index / (data.length - 1));
          const y = padding + chartHeight - ((point.weight - minWeight) / weightRange * chartHeight);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        
        ctx.stroke();
      }
      
      // Draw points
      ctx.fillStyle = '#8B5CF6';
      data.forEach((point, index) => {
        const x = padding + (chartWidth * index / Math.max(data.length - 1, 1));
        const y = padding + chartHeight - ((point.weight - minWeight) / weightRange * chartHeight);
        
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
      });
      
      // Draw weight labels on hover points
      ctx.fillStyle = '#374151';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      
      if (data.length <= 5) {
        data.forEach((point, index) => {
          const x = padding + (chartWidth * index / Math.max(data.length - 1, 1));
          const y = padding + chartHeight - ((point.weight - minWeight) / weightRange * chartHeight);
          
          ctx.fillText(point.weight + 'kg', x, y - 8);
        });
      }
    }

    function calculateTrend(data) {
      if (!data || data.length < 2) return '‚Üí';
      
      const recent = data.slice(-3); // Last 3 entries
      const firstWeight = recent[0].weight;
      const lastWeight = recent[recent.length - 1].weight;
      
      if (lastWeight > firstWeight) return '‚ÜóÔ∏è +' + (lastWeight - firstWeight).toFixed(1) + 'kg';
      if (lastWeight < firstWeight) return '‚ÜòÔ∏è -' + (firstWeight - lastWeight).toFixed(1) + 'kg';
      return '‚Üí Stable';
    }

    function loadProgressCharts() {
      if (!currentUser) return;
      
      fetch(`${API_BASE}/api/user/${currentUser.username}/progress`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            console.error('Error loading progress data:', data.error);
            return;
          }
          
          // Update current weights and trends
          const lifts = ['bench', 'squat', 'deadlift'];
          lifts.forEach(lift => {
            const liftData = data[lift] || [];
            const currentWeight = liftData.length > 0 ? liftData[liftData.length - 1].weight : 0;
            const trend = calculateTrend(liftData);
            
            document.getElementById(`${lift}-current`).textContent = `Current: ${currentWeight}kg`;
            document.getElementById(`${lift}-trend`).textContent = trend;
            
            // Draw chart
            drawProgressChart(`${lift}-chart`, liftData, lift);
          });
        })
        .catch(err => {
          console.error('Error loading progress charts:', err);
        });
    }

    // Load videos
    function loadVideos() {
      fetch(`${API_BASE}/api/videos`)
        .then(res => res.json())
        .then(data => {
          const grid = document.getElementById('videos-grid');
          if (data.length === 0) {
            grid.innerHTML = '<p class="text-muted-foreground text-center py-8 col-span-full">No videos yet. Upload the first one!</p>';
            return;
          }
          
          grid.innerHTML = data.map(video => {
            const liftEmoji = {
              'bench': 'üèãÔ∏è',
              'deadlift': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
              'squat': 'ü¶µ'
            };
            
            // Convert Instagram URL to embed URL
            const getInstagramEmbedUrl = (url) => {
              if (url.includes('/reel/')) {
                return url + 'embed/';
              } else if (url.includes('/p/')) {
                return url + 'embed/';
              }
              return url;
            };
            
            return `
              <div class="bg-card border border-border rounded-lg p-4 hover:border-purple-400 transition-colors">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <div class="flex items-center space-x-2 mb-1">
                      <span class="text-sm">${video.flag}</span>
                      <span onclick="openUserProfileModal('${video.username}')" class="text-sm font-bold text-purple-600 hover:text-purple-800 cursor-pointer underline decoration-dotted hover:decoration-solid transition-all">${video.username}</span>
                      <span class="text-xs text-muted-foreground bg-orange-500 text-white px-2 py-1 rounded">
                        ${video.dots_score ? video.dots_score + ' DOTS' : video.elo.toFixed(0) + ' ELO'}
                      </span>
                    </div>
                    <div class="text-xs text-muted-foreground">${video.team || 'Independent'}</div>
                  </div>
                  <div class="text-xs text-muted-foreground">
                    ${new Date(video.created_at).toLocaleDateString()}
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <span class="text-2xl">${liftEmoji[video.lift_type] || 'üèãÔ∏è'}</span>
                    <div>
                      <div class="font-bold text-lg">${video.weight}kg</div>
                      <div class="text-sm text-muted-foreground capitalize">${video.lift_type}</div>
                    </div>
                  </div>
                  
                  <a href="${video.video_url}" target="_blank" rel="noopener noreferrer" 
                     class="text-purple-600 hover:text-purple-800 font-medium underline transition-colors">
                    View on Instagram ‚Üí
                  </a>
                </div>
              </div>
            `;
          }).join('');
        })
        .catch(err => {
          document.getElementById('videos-grid').innerHTML = 
            '<div class="text-center py-8 text-destructive col-span-full">Error loading videos.</div>';
        });
    }

    // Load teams
    function loadTeams() {
      fetch(`${API_BASE}/api/team_leaderboard`)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('team-leaderboard');
          if (data.length === 0) {
            list.innerHTML = '<p class="text-muted-foreground text-center py-8">No teams yet.</p>';
            return;
          }
          
          list.innerHTML = data.map((team, index) => {
            const rankColors = ['text-yellow-500', 'text-gray-400', 'text-orange-500'];
            const rankColor = rankColors[index] || 'text-muted-foreground';
            const rank = index + 1;
            
            return `
              <div class="flex items-center justify-between p-4 border border-border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer" onclick="showTeamDetails('${team.team}')">
                <div class="flex items-center space-x-4">
                  <span class="text-2xl font-bold ${rankColor}">#${rank}</span>
                  <div class="flex flex-col">
                    <span class="font-semibold text-lg">${team.team}</span>
                    <span class="text-sm text-muted-foreground">${team.member_count} members</span>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold">${team.avg_elo.toFixed(0)} Avg ELO</div>
                  <div class="text-sm text-muted-foreground">
                    Top: ${team.top_elo.toFixed(0)} ELO
                  </div>
                </div>
              </div>
            `;
          }).join('');
        })
        .catch(err => {
          document.getElementById('team-leaderboard').innerHTML = 
            '<div class="text-center py-8 text-destructive">Error loading teams.</div>';
        });
    }

    // Show team details
    function showTeamDetails(teamName) {
      fetch(`${API_BASE}/api/team_members/${encodeURIComponent(teamName)}`)
        .then(res => res.json())
        .then(data => {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          modal.innerHTML = `
            <div class="bg-white p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">${teamName}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
              </div>
              <div class="space-y-3">
                ${data.map((member, index) => `
                  <div class="flex items-center justify-between p-3 border rounded">
                    <div class="flex items-center space-x-3">
                      <span class="text-lg font-bold text-muted-foreground">${index + 1}</span>
                      <span class="text-xl">${member.flag}</span>
                      <span class="font-medium">${member.display_name || member.username}</span>
                    </div>
                    <div class="text-right">
                      <div class="font-bold">${member.elo.toFixed(0)} ELO</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        })
        .catch(err => {
          alert('Error loading team details.');
        });
    }

    // Load user profile
    function loadUserProfile() {
      if (!currentUser) return;
      
      // Load profile settings
      document.getElementById('profile-username').value = currentUser.username;
      document.getElementById('profile-team').value = currentUser.team || 'Independent';
      document.getElementById('profile-weight').value = currentUser.weight || '';
      document.getElementById('profile-gender').value = currentUser.gender || '';
      
      // Load progress charts
      loadProgressCharts();
      
      // Load user posts
      fetch(`${API_BASE}/api/user/${currentUser.username}/posts`)
        .then(res => res.json())
        .then(data => {
          const postsContainer = document.getElementById('user-posts');
          if (data.length === 0) {
            postsContainer.innerHTML = '<p class="text-muted-foreground text-center py-8">No posts yet.</p>';
            return;
          }
          
          postsContainer.innerHTML = data.map(post => {
            const liftEmoji = {
              'bench': 'üèãÔ∏è',
              'deadlift': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
              'squat': 'ü¶µ'
            };
            
            const date = new Date(post.created_at).toLocaleDateString();
            
            return `
              <div class="border border-border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center space-x-2">
                    <span class="text-xl">${liftEmoji[post.lift_type] || 'üèãÔ∏è'}</span>
                    <span class="font-semibold capitalize">${post.lift_type}</span>
                    <span class="text-muted-foreground">‚Ä¢</span>
                    <span class="font-bold">${post.weight}kg</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <button onclick="editPost(${post.id}, '${post.lift_type}', ${post.weight})" class="text-blue-600 hover:text-blue-800 text-sm">
                      Edit
                    </button>
                    <button onclick="deletePost(${post.id})" class="text-destructive hover:text-destructive/80 text-sm">
                      Delete
                    </button>
                  </div>
                </div>
                ${post.video_url ? `
                  <div class="mb-3">
                    <a href="${post.video_url}" target="_blank" rel="noopener noreferrer" class="block">
                      <div class="relative bg-gradient-to-br from-purple-600 to-pink-600 h-64 flex items-center justify-center hover:from-purple-700 hover:to-pink-700 transition-all duration-300 rounded">
                        <div class="text-center">
                          <svg class="w-12 h-12 mx-auto mb-3 text-gray-800" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                          </svg>
                          <p class="text-base font-semibold mb-1 text-gray-800">View on Instagram</p>
                          <p class="text-sm text-gray-700">${post.lift_type} - ${post.weight}kg</p>
                        </div>
                      </div>
                    </a>
                  </div>
                ` : ''}
                <div class="text-sm text-muted-foreground">
                  Posted on ${date}
                </div>
              </div>
            `;
          }).join('');
        })
        .catch(err => {
          document.getElementById('user-posts').innerHTML = 
            '<div class="text-center py-8 text-destructive">Error loading posts.</div>';
        });
    }

    // Edit post function
    function editPost(postId, currentLiftType, currentWeight) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white p-6 max-w-md w-full mx-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Edit Post</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
          </div>
          <form id="edit-post-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Lift Type</label>
              <select id="edit-lift-type" class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring">
                <option value="bench" ${currentLiftType === 'bench' ? 'selected' : ''}>Bench Press</option>
                <option value="deadlift" ${currentLiftType === 'deadlift' ? 'selected' : ''}>Deadlift</option>
                <option value="squat" ${currentLiftType === 'squat' ? 'selected' : ''}>Squat</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Weight (kg)</label>
              <input 
                type="number" 
                id="edit-weight" 
                value="${currentWeight}"
                step="0.5" 
                min="0" 
                class="w-full px-3 py-2 border border-input bg-input focus:outline-none focus:border-ring"
                required
              >
            </div>
            <div class="flex space-x-3">
              <button type="submit" class="flex-1 bg-primary text-primary-foreground py-2 px-4 hover:bg-primary/90 transition-colors">
                Update Post
              </button>
              <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 px-4 hover:bg-gray-600 transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#edit-post-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const liftType = document.getElementById('edit-lift-type').value;
        const weight = document.getElementById('edit-weight').value;
        
        fetch(`${API_BASE}/api/posts/${postId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username,
            lift_type: liftType,
            weight: parseFloat(weight)
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert('Error updating post: ' + data.error);
          } else {
            alert('Post updated successfully!');
            modal.remove();
            loadUserProfile(); // Reload posts
            loadLeaderboard(); // Update leaderboard
          }
        })
        .catch(err => {
          alert('Error updating post.');
        });
      });
      
      document.body.appendChild(modal);
    }

    // Delete post function
    function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
      }
      
      fetch(`${API_BASE}/api/posts/${postId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: currentUser.username })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Error deleting post: ' + data.error);
        } else {
          alert('Post deleted successfully!');
          loadUserProfile(); // Reload posts
          loadLeaderboard(); // Update leaderboard
        }
      })
      .catch(err => {
        alert('Error deleting post.');
      });
    }


    // User session management
    let currentUser = null;
    let currentGenderFilter = '';
    let currentCountryFilter = '';


    // Auto-fill username when logged in
    function updateUIForLoggedInUser() {
      if (currentUser) {
        // Show user info, logout button, hide auth buttons
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('logged-in-user').innerHTML = `
          <span>${currentUser.flag}</span>
          <div class="text-left">
            <div class="font-medium">${currentUser.display_name || currentUser.username}</div>
            <div class="text-xs text-muted-foreground">${currentUser.team || 'Independent'}</div>
          </div>
        `;
        document.getElementById('auth-buttons').classList.add('hidden');
        
        // Show PR section, hide welcome section
        document.getElementById('pr-section').classList.remove('hidden');
        document.getElementById('welcome-section').classList.add('hidden');
        
      } else {
        // Show auth buttons, hide user info, logout button
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
        document.getElementById('auth-buttons').classList.remove('hidden');
        
        // Hide PR section, show welcome section
        document.getElementById('pr-section').classList.add('hidden');
        document.getElementById('welcome-section').classList.remove('hidden');
      }
    }

    // Logout function
    function logout() {
      currentUser = null;
      localStorage.removeItem('gymrank_user');
      
      // Update UI
      updateUIForLoggedInUser();
      
      alert('Logged out successfully!');
    }

    // Check for saved user session on page load
    function checkUserSession() {
      const savedUser = localStorage.getItem('gymrank_user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          updateUIForLoggedInUser();
        } catch (e) {
          localStorage.removeItem('gymrank_user');
        }
      }
    }

    // Load initial data and check session on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all event listeners once DOM is ready
      initializeEventListeners();
      
      checkUserSession();
      showSection('home');
      loadLeaderboard();
    });

    // Initialize all event listeners
    function initializeEventListeners() {
      // Only add listeners if elements exist
      const combinedPrForm = document.getElementById('combined-pr-form');
      const profileSettingsForm = document.getElementById('profile-settings-form');
      
      if (combinedPrForm) {
        combinedPrForm.addEventListener('submit', handleCombinedPR);
      }
      
      if (profileSettingsForm) {
        profileSettingsForm.addEventListener('submit', handleProfileUpdate);
      }
    }

    // Handle profile update
    function handleProfileUpdate(e) {
      e.preventDefault();
      
      const newUsername = document.getElementById('profile-username').value;
      const team = document.getElementById('profile-team').value;
      const weight = document.getElementById('profile-weight').value;
      const gender = document.getElementById('profile-gender').value;
      
      if (!newUsername || !team || !gender) {
        alert('Username, team, and gender are required');
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Updating...';
      submitBtn.disabled = true;
      
      fetch(`${API_BASE}/api/profile/update`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: currentUser.username,
          new_username: newUsername,
          team: team,
          weight: weight ? parseFloat(weight) : null,
          gender: gender
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Update failed: ' + data.error);
        } else {
          // Update currentUser with new data
          currentUser = { ...currentUser, ...data };
          localStorage.setItem('gymrank_user', JSON.stringify(currentUser));
          
          // Update UI
          updateUIForLoggedInUser();
          
          alert('Profile updated successfully!');
          loadUserProfile(); // Reload profile data
          loadLeaderboard(); // Update leaderboard
        }
      })
      .catch(err => {
        alert('Update failed. Please try again.');
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }


    function handleCombinedPR(e) {
      e.preventDefault();
      
      const username = currentUser.username;
      const lift_type = document.getElementById('lift-type').value;
      const weight = parseFloat(document.getElementById('weight').value);
      const instagramUrl = document.getElementById('instagram-url').value;
      
      // Validate that Instagram URL is required and valid
      if (!instagramUrl) {
        alert('Instagram video link is required to submit a PR.');
        return;
      }
      
      if (!instagramUrl.includes('instagram.com')) {
        alert('Please enter a valid Instagram URL.');
        return;
      }
      
      // Show loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;
      
      // Submit with Instagram URL
      const formData = new FormData();
      formData.append('username', username);
      formData.append('lift_type', lift_type);
      formData.append('weight', weight);
      formData.append('instagram_url', instagramUrl);
      
      fetch(`${API_BASE}/api/submit_pr`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Submission failed: ' + data.error);
        } else {
          alert('PR with Instagram video submitted successfully!');
          document.getElementById('combined-pr-form').reset();
          loadVideos();
          loadLeaderboard();
        }
      })
      .catch(err => {
        alert('Upload failed. Please try again.');
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }
  </script>
</body>
</html> 